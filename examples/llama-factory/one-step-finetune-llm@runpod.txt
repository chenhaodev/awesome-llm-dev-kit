#q- finetune llm + eval @runpod, llm-finetune-eval-runpod-f3068c0-20240206222609, (do not train chat-model otherwise downgrade), (https://huggingface.co/spaces/hiyouga/LLaMA-Board)

opt-1: git clone https://github.com/chenhaodev/llm-llama-factory; cd llm-llama-factory/; python create_pods.py 'chargoddard/Yi-34B-Llama' 'NVIDIA A100 80GB PCIe' 1 LVEA98VLXKAR5CVCFYYPIR6FG4UCJYDLN9N3H96F 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 "--per_device_train_batch_size 4 --gradient_accumulation_steps 4 --lora_target q_proj,v_proj --template llama2 --dataset oncc_medqa_instruct" 902i850eaw

opt-2: apt-get update; apt-get install -y tmux vim git-lfs; tmux new -s download; cd /workspace/; mkdir -p cache model; pip install huggingface_hub; huggingface-cli login --token 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; huggingface-cli download --resume-download [xxx, e.g mistralai/Mistral-7B-v0.1] --local-dir /workspace/model --local-dir-use-symlinks False --cache-dir /workspace/cache;
tmux new -s train; cd /workspace/; git clone https://github.com/chenhaodev/llm-llama-factory; cd llm-llama-factory/; pip install -r requirements.txt; CUDA_VISIBLE_DEVICES=0 python src/train_bash.py --stage sft --do_train True --model_name_or_path /workspace/model --finetuning_type lora --quantization_bit 4 --template mistral --flash_attn True --dataset_dir data --dataset [xxx, e.g medical_meadow_wikidoc] --cutoff_len 1024 --learning_rate 0.0005 --num_train_epochs 1.0 --max_samples 5000 --per_device_train_batch_size 4 --gradient_accumulation_steps 4 --lr_scheduler_type cosine --max_grad_norm 1.0 --logging_steps 10 --save_steps 100 --warmup_steps 20 --neftune_noise_alpha 0.5 --lora_rank 8 --lora_dropout 0.2 --lora_target q_proj,v_proj --output_dir [xxx, e.g /workspace/mistral-7b-medwiki-v1] --fp16 True --plot_loss True
git lfs install; git clone [xxx, e.g https://huggingface.co/chenhugging/mistral-7b-medwiki-v1]; huggingface-cli lfs-enable-largefiles .; cd [xxx, e.g /workspace/mistral-7b-medwiki-v1/]; huggingface-cli upload mistral-7b-medwiki-v1 . . #after sft training, upload lora-adapter to hub. remember to edit adapter_config.json: base_model_name_or_path=/workspace/model -> mistralai/Mistral-7B-v0.1

#git clone https://github.com/chenhaodev/lm-evaluation-harness; cd lm-evaluation-harness/; pip install -e .; lm_eval --model hf --model_args pretrained=[xxx, e.g mistralai/Mistral-7B-v0.1],trust_remote_code=True,parallelize=True,load_in_4bit=True,peft=[xxx, e.g chenhugging/mistral-7b-medwiki-v1] --tasks ocn,aocnp,medmcqa,pubmedqa,mmlu_clinical_knowledge,mmlu_college_medicine,mmlu_professional_medicine --device cuda:0 --limit 100
